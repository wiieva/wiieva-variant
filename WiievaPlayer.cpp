#include <Arduino.h>
#include <WiievaPlayer.h>
#include <WiievaWiring.h>


using namespace wiieva;

uint16_t sinetable[400] = {
1024,1040,1056,1072,1088,1104,1120,1136,1152,1168,1184,1200,1216,1232,1247,1263,1279,1294,1310,1325,
1340,1356,1371,1386,1401,1416,1431,1445,1460,1474,1489,1503,1517,1531,1545,1559,1573,1586,1600,1613,
1626,1639,1652,1664,1677,1689,1701,1713,1725,1737,1748,1759,1770,1781,1792,1803,1813,1823,1833,1843,
1852,1862,1871,1880,1889,1897,1905,1913,1921,1929,1936,1944,1951,1957,1964,1970,1976,1982,1987,1993,
1998,2003,2007,2012,2016,2020,2023,2027,2030,2033,2035,2038,2040,2042,2043,2045,2046,2047,2047,2048,
2048,2048,2047,2047,2046,2045,2043,2042,2040,2038,2035,2033,2030,2027,2023,2020,2016,2012,2007,2003,
1998,1993,1987,1982,1976,1970,1964,1957,1951,1944,1936,1929,1921,1913,1905,1897,1889,1880,1871,1862,
1852,1843,1833,1823,1813,1803,1792,1781,1770,1759,1748,1737,1725,1713,1701,1689,1677,1664,1652,1639,
1626,1613,1600,1586,1573,1559,1545,1531,1517,1503,1489,1474,1460,1445,1431,1416,1401,1386,1371,1356,
1340,1325,1310,1294,1279,1263,1247,1232,1216,1200,1184,1168,1152,1136,1120,1104,1088,1072,1056,1040,
1024,1008,992,976,960,944,928,912,896,880,864,848,832,816,801,785,769,754,738,723,
708,692,677,662,647,632,617,603,588,574,559,545,531,517,503,489,475,462,448,435,
422,409,396,384,371,359,347,335,323,311,300,289,278,267,256,245,235,225,215,205,
196,186,177,168,159,151,143,135,127,119,112,104,97,91,84,78,72,66,61,55,
50,45,41,36,32,28,25,21,18,15,13,10,8,6,5,3,2,1,1,0,
0,0,1,1,2,3,5,6,8,10,13,15,18,21,25,28,32,36,41,45,
50,55,61,66,72,78,84,91,97,104,112,119,127,135,143,151,159,168,177,186,
196,205,215,225,235,245,256,267,278,289,300,311,323,335,347,359,371,384,396,409,
422,435,448,462,475,489,503,517,531,545,559,574,588,603,617,632,647,662,677,692,
708,723,738,754,769,785,801,816,832,848,864,880,896,912,928,944,960,976,992,1008
};
uint16_t sineptr = 0;

void WiievaPlayer::start (int _mode)
{
    sendCommand (AIO_CMD_AUDIO_OUT_MODE,0,_mode);
    mode = _mode;
    buf.flush ();
    bufFilled = false;

}

void WiievaPlayer::stop ()
{
    sendCommand (AIO_CMD_AUDIO_OUT_MODE,0,AIO_AUDIO_OFF);
}

bool WiievaPlayer::run ()
{
    uint16_t tmpbuf[64];
    size_t sz = 0;

    if (buf.available() > (buf.size()-512))
        bufFilled = true;
    else if (!buf.available())
       bufFilled = false;

    if (!bufFilled)
        return false;
    do {
        sz = buf.peek ((char*)tmpbuf,sizeof(tmpbuf)) & ~1;
        if (sz) {
            sz = sendBuffer (AIO_CMD_WR_STREAM,sz,(uint8_t*)tmpbuf);
            buf.remove (sz);
        }
    } while (sz);
    yield ();
    return false;
}

bool WiievaPlayer::run (Stream &stream)
{
    uint8_t tmpbuf[128];
    size_t sz = stream.available();
    if (sz) {
        size_t freesz = buf.room();
        sz = stream.readBytes((char*)tmpbuf,min (min (sizeof(tmpbuf),sz),freesz));
        buf.write((char*)tmpbuf,sz);
    }
    return run();
}

bool WiievaPlayer::run (int freq)
{


}
